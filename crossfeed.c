/*
 * Copyright (c) 2013 Jeremy Pepper
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 *  * Redistributions of source code must retain the above copyright notice,
 *    this list of conditions and the following disclaimer.
 *  * Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *  * Neither the name of crossfeed nor the names of its contributors may
 *    be used to endorse or promote products derived from this software
 *    without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */

#include "crossfeed.h"
#include <string.h>

static const float kernel_96k[] = {
	1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -0.12079715, -0.16337833, -0.11155132, -0.070334852, -0.044668935, -0.031552959, -0.022942079, -0.018355014, -0.014792344, -0.012847221, -0.01110846, -0.010149362, -0.0091714021, -0.0086397491, -0.0080326581, -0.0076808934, -0.0072738854, -0.0070569431, -0.006766357, -0.0066089774, -0.0063901413, -0.0062667155, -0.0060942317, -0.0059908731, -0.0058493726, -0.0057576122, -0.0056379121, -0.0055530109, -0.0054486687, -0.005367768, -0.0052749817, -0.0051960773, -0.0051124115, -0.0050342144, -0.004957594, -0.0048799566, -0.0048087942, -0.0047315932, -0.0046647647, -0.0045880736, 0, -0.0044488478, -0.0043883324, -0.0043131621, -0.0042553912, -0.0041809957, -0.0041256575, -0.0040519899, -0.0039992025, -0.0039263177, -0.0038722332, -0.0037993449, -0.0037518647, -0.0036801859, -0.0036351923, -0.0035644853, -0.0035217877, -0.0034522375, -0.003411765, -0.0033432916, -0.0033050608, -0.0032378165, -0.003201701, -0.003135741, -0.003101812, -0.0030369211, -0.0030051304, -0.0029414948, -0.0029117549, -0.0028493218, -0.0028216294, -0.0027604823, -0.0027346942, -0.0026747421, -0.0026509524, -0.0025921389, -0.0025701935, -0.0025125851, -0.0024924083, -0.0024360425, -0.002417594, -0.0023623421, -0.0023455913, -0.0022914123, -0.0022763116, -0.0022231929, -0.0022096783, -0.0021576458, -0.0021455325, -0.0020945873, -0.002083943, -0.0020340187, -0.0020246559, -0.0019757783, -0.001967768, -0.0019226976, -0.0019156693, -0.0018684114, -0.0018625235, -0.0018166781, -0.0018120883, -0.0017670627, -0.0017635366, -0.0017193764, -0.0017169669, -0.0016736246, -0.0016722296, -0.0016296121, -0.0016291949, -0.0015873581, -0.0015878781, -0.0015466989, -0.0015481567, -0.0015076894, -0.0015100564, -0.0014701558, -0.0014733881, -0.0014341106, -0.0014381311, -0.0013994711, -0.0014042661, -0.0013661602, -0.0013716801, -0.0013340804, -0.0013403732, -0.0013032573, -0.0013103053, -0.0012735884, -0.0012813195, -0.0012449821, -0.0012533774, -0.0012173878, -0.0012264509, -0.0011908542, -0.0012004694, -0.0011650518, -0.0011754337, -0.0011403664, -0.0011510011, -0.0011165042, -0.0011274836, -0.0010936469, -0.0011047557, -0.0010716389, -0.0010831206, -0.0010504884, -0.0010621129, -0.0010301328, -0.0010420291, -0.0010100934, -0.0010227392, -0.00099080417, -0.0010035298, -0.00097131939, -0.00098492217, -0.00095149485, -0.00096580305, -0.00093430217, -0.00094745529, -0.00091571186, -0.00092852057, -0.00089820725, -0.00091235072, -0.00088002527, -0.00089434453, -0.00086320256, -0.00087612501, -0.000846393, -0.00085814967, -0.00082833774, -0.00084216648, -0.00081156066, -0.0008258812, -0.00079436647, -0.00080871844, -0.00077925122, -0.00079187786, -0.00076296867, -0.00077455025, -0.00074637664, -0.00076101971, -0.00072876317, -0.00074426079, -0.00071750447, -0.00073097635, -0.0006975538, -0.0007143059, -0.00068323582, -0.00069813587, -0.00066632766, -0.0006793178, -0.00065208273, -0.00066802738, -0.00063831807, -0.00065546366, -0.0006276308, -0.00064448197, -0.00061475643, -0.00062615325, -0.00060062698, -0.00061772694, -0.00059031823, -0.00059325545, -0.00057195505, -0.00058761192, -0.0005604882, -0.00056289387, -0.00053697301, -0.00054998609, -0.00052879413, -0.00054492668, -0.00052208517, -0.00053463067, -0.00051451597, -0.00051166001, -0.00048925244, -0.0005012792, -0.00047865548, -0.00049437227, -0.00046930517, -0.00047326845, -0.00045372749, -0.00046915663, -0.00045249675, -0.00046821951, -0.00045239192, -0.00046729844, -0.0004512537, -0.00042795466, -0.00041156643, -0.00041429052, -0.00039673148, -0.00040650385, -0.00037465908, -0.00038556315, -0.00036901468, -0.00037976116, -0.00036850432, -0.00035757347, -0.0003433708, -0.00035247914, -0.00033841998, -0.00033932322, -0.0003240355, -0.00032232096, -0.00029898377, -0.00030721957, -0.00027350258, -0.00027566755, -0.00027084319, -0.00026093112, -0.0002531542, -0.00025786535, -0.00025358831, -0.00025718141, -0.00015299987, -0.00014788321, -0.00015682176, -0.00016542384, -0.00014671568, -0.0001420591, -0.00013191914, -0.00013409772, -0.00010879651, -0.00010267504, -0.00010171254, -0.00010332318, -9.8325661E-05, -9.9915793E-05, -9.5228126E-05, -9.072158E-05, -8.6372558E-05, -8.6657463E-05, -6.2307459E-05, -6.4054257E-05, -6.2125844E-05, -6.0234161E-05, -5.8357313E-05, -5.8166443E-05, -5.7165274E-05, -5.8919028E-05, -3.9043745E-05, -3.9974821E-05, -3.6176483E-05, -3.6111433E-05, -3.484228E-05, -3.2107881E-05, -3.0081954E-05, -1.5938554E-05, -1.5355496E-05, -1.5459693E-05, -1.5095003E-05, -1.5403182E-05, -1.5394191E-05, -1.5368618E-05, -1.4771182E-05, -1.4957862E-05, -1.434957E-05, -1.4727982E-05, -1.4505542E-05, -1.4143686E-05, -1.3672964E-05, -1.3520524E-05, -1.3075366E-05, -1.3127086E-05, -1.283049E-05, -1.3074083E-05, -1.2949019E-05, -1.2043693E-05, -1.0919032E-05, -9.3725612E-06, -8.8942879E-06, -8.3706655E-06, -7.2999683E-06, -6.5421486E-06, -4.2657111E-06, -4.152585E-06, -4.068705E-06, -3.9583829E-06, -3.90373E-06, -3.6764286E-06, -3.2337275E-06, -2.1836577E-06, -2.0036343E-06
};

static const float kernel_48k[] = {
	1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -0.27798355, -0.1912874, -0.070722617, -0.043664753, -0.025887411, -0.022166457, -0.016902806, -0.016126597, -0.013743138, -0.013534356, -0.012224127, -0.012113629, -0.011260218, -0.011139737, -0.010521083, -0.010366449, -0.0098833935, -0.0096946955, -0.0092977658, -0.0090806847, 0, -0.0085067013, -0.0082163736, -0.0079651074, -0.0077049066, -0.0074252691, -0.0072251703, -0.0069422582, -0.0067704944, -0.0064877034, -0.0063414411, -0.0060613574, -0.0059381179, -0.0056626867, -0.0055608712, -0.0052911532, -0.0052090934, -0.004945518, -0.0048816889, -0.0046248464, -0.0045778058, -0.004327782, -0.0042959214, -0.0040527242, -0.0040350598, -0.0038010883, -0.0037886477, -0.003565873, -0.0035654027, -0.0033485421, -0.0033589939, -0.0031477427, -0.0031681331, -0.0029620312, -0.0029917215, -0.0027904739, -0.0028285321, -0.0026318245, -0.0026775717, -0.0024849186, -0.0025377905, -0.0023489832, -0.0024082346, -0.002223152, -0.0022881923, -0.0021061832, -0.0021768133, -0.0019977314, -0.0020733443, -0.0018961759, -0.0019770698, -0.0018021588, -0.0018861748, -0.0017143188, -0.0018019449, -0.0016313933, -0.001722739, -0.0015535478, -0.0016471782, -0.0014796366, -0.0015767427, -0.0014103203, -0.0015048587, -0.0013398961, -0.001439337, -0.0012759091, -0.001376717, -0.0012124847, -0.0013141287, -0.0011498093, -0.0012537193, -0.0010918552, -0.0011900601, -0.0010354952, -0.0011405537, -0.00098850194, -0.0010812524, -0.00092882675, -0.0010322037, -0.00088786107, -0.00097160373, -0.00083106075, -0.00093403284, -0.00077585137, -0.00086989143, -0.00073641521, -0.00083607802, -0.00069050281, -0.00078870408, -0.00064667116, -0.00073851133, -0.0006133272, -0.00069617055, -0.0005754694, -0.00066566851, -0.00055587234, -0.00064828544, -0.00051840121, -0.00060559559, -0.00048259614, -0.00056873751, -0.00045741332, -0.00053275819, -0.00042737316, -0.00050657673, -0.00040380753, -0.00047797285, -0.00037402028, -0.00045016478, -0.00036391296, -0.00043815657, -0.00035253304, -0.00042389886, -0.00032000447, -0.00039132152, -0.000308346, -0.00037907314, -0.00027783783, -0.0003423134, -0.00026685407, -0.00032820844, -0.00025549572, -0.00031915426, -0.00024950845, -0.00031331106, -0.00024375985, -0.0003047121, -0.00023167512, -0.00029377788, -0.00021098087, -0.00026917647, -0.00020554932, -0.0002579671, -0.00018912554, -0.00023573737, -0.00017905277, -0.00023202364, -0.00017541638, -0.00022846548, -0.00016780417, -0.00021377717, -0.00015001174, -0.00019520467, -0.00014349622, -0.00018977791, -0.00013678463, -0.00018114578, -0.00013246907, -0.00017386078, -0.00012782137, -0.00016796069, -0.00012296741, -0.00015612481, -0.00011261507, -0.00015220777, -0.0001102789, -0.0001500918, -0.00010704304, -0.00014521441, -0.00010239414, -0.00013779983, -9.8622368E-05, -0.00013624132, -9.7093209E-05, -0.00013474705, -9.5630734E-05, -0.00013330959, -9.4215975E-05, -0.00013194424, -9.2857961E-05, -0.00013062269, -9.1576927E-05, -0.00012372661, -8.6374093E-05, -0.00012256874, -8.5246626E-05, -0.00012145493, -8.4158331E-05, -0.00012039653, -8.3126106E-05, -0.00011938276, -7.840027E-05, -0.00010510991, -7.0282556E-05, -9.9222394E-05, -6.4363572E-05, -9.1616261E-05, -6.1061284E-05, -8.9104113E-05, -5.7946596E-05, -8.4555191E-05, -5.6343295E-05, -7.9851336E-05, -5.3928739E-05, -7.8362355E-05, -5.284524E-05, -7.7584045E-05, -5.2107272E-05, -7.6913471E-05, -5.1647155E-05, -7.6398479E-05, -5.1188679E-05, -7.567666E-05, -5.1435945E-05, -7.4678544E-05, -4.8547212E-05, -7.1392235E-05, -4.6201563E-05, -6.8201334E-05, -4.3981076E-05, -6.4259257E-05, -4.0819988E-05, -6.1584222E-05, -4.0454262E-05, -6.1234496E-05, -4.0116771E-05, -6.091359E-05, -3.9805906E-05, -6.0615068E-05, -3.9515187E-05, -6.0328133E-05, -3.9249466E-05, -6.0075472E-05, -3.5653135E-05, -5.4012533E-05, -3.3670352E-05, -5.1547999E-05, -3.3120356E-05, -5.1024115E-05, -3.2959349E-05, -5.0875133E-05, -3.2814118E-05, -5.0669114E-05, -3.2645698E-05, -5.0529205E-05, -3.2426888E-05, -4.9808783E-05, -3.2214321E-05, -5.0078084E-05, -3.2209933E-05, -5.0031318E-05, -3.2176926E-05, -4.9978076E-05, -3.2173215E-05, -4.9965314E-05, -3.2241784E-05, -4.9931834E-05, -3.2433043E-05, -4.9778384E-05, -3.2531188E-05, -4.9367205E-05, -3.1695476E-05, -4.8929815E-05, -3.1529416E-05, -4.8870806E-05, -3.1529122E-05, -4.8882961E-05, -3.1590007E-05, -4.8938346E-05, -3.170062E-05, -4.9001901E-05, -3.1996355E-05, -4.9082304E-05, -3.1980067E-05, -4.8713046E-05, -3.1773463E-05, -4.8425514E-05, -3.1584699E-05, -4.8200272E-05, -2.3974078E-05, -3.505015E-05, -2.2852701E-05, -3.4013156E-05, -2.1270227E-05, -3.2634231E-05, -2.1077552E-05, -3.170321E-05, -1.977043E-05, -2.7452872E-05, -1.7392435E-05, -2.6467062E-05, -1.7635908E-05, -2.6273499E-05, -1.7675044E-05, -2.624728E-05, -1.76181E-05, -2.6221725E-05, -1.7824856E-05, -2.6091297E-05, -1.7605482E-05, -2.5850486E-05, -1.7628659E-05, -2.5049067E-05, -1.679424E-05, -2.4732784E-05, -1.6717564E-05, -2.4764047E-05, -1.6798058E-05, -2.4890505E-05, -1.6924569E-05, -2.5152187E-05, -1.7159891E-05, -2.485812E-05, -1.7031511E-05, -2.4939762E-05, -1.7179444E-05, -2.5126417E-05, -1.7399194E-05, -2.5363624E-05, -1.766857E-05, -2.5644687E-05, -1.7991357E-05, -2.6004E-05, -1.8477656E-05, -2.6075504E-05, -1.8545377E-05, -2.61403E-05, -1.8657604E-05, -2.6409192E-05, -1.490994E-05, -2.1106192E-05, -1.5217134E-05, -2.0820069E-05, -1.517751E-05, -2.0825417E-05, -1.5429114E-05, -2.0876385E-05, -1.5723916E-05, -2.1019951E-05, -1.5844917E-05, -2.1143585E-05, -1.6440372E-05, -2.1219445E-05, -1.6061458E-05, -2.0637355E-05, -1.5676598E-05, -2.0670037E-05, -1.5984275E-05, -2.1124935E-05, -1.6779122E-05, -2.1012098E-05, -1.6393633E-05, -2.0476436E-05, -1.6941583E-05, -2.0508656E-05, -1.6158789E-05, -2.0136662E-05, -1.5974705E-05, -2.0025662E-05, -1.6201819E-05, -2.0373458E-05, -1.680399E-05, -2.0882459E-05, -1.7464954E-05, -2.0969326E-05, -1.8502733E-05, -2.1014401E-05, -1.7350969E-05, -2.0322381E-05, -1.7937851E-05, -2.0449101E-05, -1.6849233E-05, -1.7718923E-05, -1.5251765E-05, -1.7824656E-05, -1.6126744E-05, -1.8241379E-05, -1.6036302E-05, -1.7793847E-05, -1.5862408E-05, -1.7662098E-05, -1.5942824E-05, -1.6939235E-05, -1.5798163E-05, -1.6580299E-05, -1.537491E-05, -1.5883987E-05, -1.4026577E-05, -1.5299624E-05, -3.7918701E-06, -3.6754293E-06, -2.5806198E-06, -2.2257843E-06, -2.197859E-06, -2.1262956E-06, -2.0755888E-06
};

static const float kernel_44k[] = {
	1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -0.32902133, -0.14283958, -0.10621008, -0.063561536, -0.034955837, -0.023587259, -0.020500259, -0.019937599, -0.018318519, -0.016559841, -0.014087128, -0.012336781, -0.01043045, -0.009339733, -0.0080171628, -0.0073263007, -0.0063451561, -0.0059215762, 0, -0.0048690136, -0.0042159581, -0.0040657455, -0.0034906911, -0.0034301514, -0.0029379074, -0.0029229564, -0.002463964, -0.0024960164, -0.0020639268, -0.0021068556, -0.0017180453, -0.0017676551, -0.0013988588, -0.0014619518, -0.0011154554, -0.0011955067, -0.00090806349, -0.0010065819, -0.00069408235, -0.00079659006, -0.00056140206, -0.00065356359, -0.00047988596, -0.00057135563, -0.0003706509, -0.00045749109, -0.00032035034, -0.00037655298, -0.00026647336, -0.00031992898, -0.00021972654, -0.00029536302, -0.00019782456, -0.00025334375, -0.0001646848, -0.00022220545, -0.00012606183, -0.00018475634, -0.00011254348, -0.00017312077, -0.00010074762, -0.00013852, -7.7550212E-05, -0.00012899606, -6.6800232E-05, -0.00011513496, -5.910451E-05, -0.00010428485, -4.9393668E-05, -9.4195493E-05, -4.3437696E-05, -8.7174543E-05, -3.8321785E-05, -8.142693E-05, -3.2417171E-05, -7.2573144E-05, -2.8216618E-05, -6.8360743E-05, -2.4868788E-05, -6.5210414E-05, -2.1886599E-05, -6.2307663E-05, -1.9141984E-05, -5.9606129E-05, -1.6610931E-05, -5.5501165E-05, -1.3751419E-05, -5.2745843E-05, -1.1603156E-05, -5.0644383E-05, -9.6240565E-06, -4.8694426E-05, -7.7729774E-06, -4.6867048E-05, -6.0528591E-06, -4.5165219E-05, -4.4456428E-06, -4.3573869E-05, -2.940867E-06, -4.2086198E-05, -1.4188007E-06, -3.7548856E-05, -1.9660683E-07, -3.6330432E-05, 9.5480652E-07, -3.5179615E-05, 2.0348791E-06, -3.4103192E-05, 3.0420567E-06, -3.288659E-05, 3.6844726E-06, -2.8760825E-05, 4.4294197E-06, -2.7452978E-05, 5.1135371E-06, -2.6691227E-05, 5.8277078E-06, -2.5969908E-05, 6.5042077E-06, -2.5286146E-05, 7.1388226E-06, -2.4636885E-05, 7.7444693E-06, -2.4022827E-05, 8.3095592E-06, -2.3443325E-05, 8.8516126E-06, -2.2887205E-05, 9.3625913E-06, -2.23592E-05, 9.8484388E-06, -2.1861004E-05, 1.0310775E-05, -2.1385431E-05, 1.0748792E-05, -2.0932808E-05, 1.1164225E-05, -2.0497839E-05, 1.1561016E-05, -2.0082403E-05, 1.193239E-05, -1.9690857E-05, 1.2291162E-05, -1.9313162E-05, 1.2631861E-05, -1.8955929E-05, 1.2952756E-05, -1.8610932E-05, 1.3262254E-05, -1.8284456E-05, 1.3554974E-05, -1.7967926E-05, 1.3838113E-05, -1.7667722E-05, 1.4101805E-05, -1.7380111E-05, 1.4357769E-05, -1.7105584E-05, 1.4599344E-05, -1.6841543E-05, 1.4833617E-05, -1.6589189E-05, 1.5049418E-05, -1.6344638E-05, 1.5261279E-05, -1.6114676E-05, 1.5463904E-05, -1.5892296E-05, 1.5651984E-05, -1.5675747E-05, 1.5835838E-05, -1.5470823E-05, 1.6008649E-05, -1.5260919E-05, 1.6145013E-05, -1.5060438E-05, 1.6304553E-05, -1.4879838E-05, 1.6456039E-05, -1.470362E-05, 1.6597953E-05, -1.4541257E-05, 1.6732069E-05, -1.4379479E-05, 1.6861395E-05, -1.4226149E-05, 1.6985401E-05, -1.4075733E-05, 1.7103857E-05, -1.3937761E-05, 1.7191951E-05, -1.3445648E-05, 1.695904E-05, -1.3323273E-05, 1.7052187E-05, -1.3204144E-05, 1.7142673E-05, -1.3087079E-05, 1.7227483E-05, -1.2975761E-05, 1.7313147E-05, -1.2869206E-05, 1.7394854E-05, -1.2765465E-05, 1.7468064E-05, -1.2667199E-05, 1.7536027E-05, -1.1402004E-05, 1.6156602E-05, -1.08777E-05, 1.5757987E-05, -1.0799496E-05, 1.5810992E-05, -1.0727733E-05, 1.5859168E-05, -1.0656955E-05, 1.5904539E-05, -1.0587485E-05, 1.5944519E-05, -1.0522582E-05, 1.598442E-05, -1.046239E-05, 1.6014577E-05, -1.0402853E-05, 1.6049224E-05, -1.0347245E-05, 1.6079823E-05, -1.029637E-05, 1.61064E-05, -1.0245691E-05, 1.6128079E-05, -1.0197432E-05, 1.6150887E-05, -1.0151211E-05, 1.6171174E-05, -1.0109229E-05, 1.6187092E-05, -1.0072083E-05, 1.6199678E-05, -1.0032881E-05, 1.6209813E-05, -9.9970785E-06, 1.6220698E-05, -9.9644967E-06, 1.6227488E-05, -9.9314339E-06, 1.596533E-05, -9.3016388E-06, 1.4451121E-05, -8.441405E-06, 1.4256455E-05, -8.3404502E-06, 1.4031903E-05, -8.2077695E-06, 1.395189E-05, -8.232766E-06, 1.3996741E-05, -7.7482182E-06, 1.3434593E-05, -7.5755329E-06, 1.2519689E-05, -6.0348452E-06, 1.0757436E-05, -5.6089239E-06, 9.9327153E-06, -5.3761751E-06, 9.8091687E-06, -5.3418253E-06, 9.7659886E-06, -5.3513068E-06, 9.7414431E-06, -5.3571848E-06, 9.7226193E-06, -5.3642302E-06, 9.7002867E-06, -5.3656127E-06, 9.6816548E-06, -5.3744761E-06, 9.6598706E-06, -5.3827248E-06, 9.6358544E-06, -5.3928902E-06, 9.6081376E-06, -5.4024281E-06, 9.586186E-06, -5.4147499E-06, 9.5590713E-06, -5.425577E-06, 9.5304458E-06, -5.4417142E-06, 9.4996067E-06, -5.4562956E-06, 9.4685847E-06, -5.473551E-06, 9.4354591E-06, -5.4926022E-06, 9.4009756E-06, -5.5107839E-06, 9.366634E-06, -5.5319792E-06, 9.3264289E-06, -5.5593591E-06, 9.2915534E-06, -5.5694572E-06, 9.2170294E-06, -5.5280284E-06, 9.0272351E-06, -5.5043383E-06, 8.9828181E-06, -5.5294204E-06, 8.9450423E-06, -5.5601549E-06, 8.8979841E-06, -5.5940268E-06, 8.848745E-06, -5.6326671E-06, 8.7961307E-06, -5.6685662E-06, 8.7408262E-06, -5.7085485E-06, 8.6905457E-06, -5.6919071E-06, 7.8874582E-06, -5.1337083E-06, 7.7180348E-06, -5.1728298E-06, 7.6620054E-06, -5.2178834E-06, 7.6062274E-06, -5.2612654E-06, 7.5489193E-06, -5.3114049E-06, 7.4855766E-06, -5.362273E-06, 7.4207092E-06, -5.4151965E-06, 7.3523083E-06, -5.4690904E-06, 7.2558992E-06, -5.3132194E-06, 6.8700192E-06, -5.2875421E-06, 6.7996175E-06, -5.3495128E-06, 6.725948E-06, -5.4117954E-06, 6.6507246E-06, -5.476807E-06, 6.572347E-06, -5.5446158E-06, 6.488257E-06, -5.6162048E-06, 6.4040883E-06, -5.6908184E-06, 6.3152265E-06, -5.7697671E-06, 6.224162E-06, -5.8519336E-06, 6.127606E-06, -5.9373342E-06, 6.0290718E-06, -6.0247548E-06, 5.9243016E-06, -6.1185688E-06, 5.8174028E-06, -6.2161162E-06, 5.7070365E-06, -6.3162629E-06, 5.5908977E-06, -6.4250266E-06, 5.4698176E-06, -6.5349955E-06, 5.3426961E-06, -6.6516645E-06, 5.2113874E-06, -6.7731826E-06, 5.0732051E-06, -6.902515E-06, 4.9289106E-06, -7.0368678E-06, 4.7802264E-06, -7.1735562E-06, 4.6223263E-06, -7.3211077E-06, 4.4582371E-06, -7.4759673E-06, 4.28672E-06, -7.6412562E-06, 4.1084395E-06, -7.8131825E-06, 3.9208835E-06, -7.9932252E-06, 3.7222255E-06, -8.1844209E-06, 3.5134319E-06, -8.3864161E-06, 3.2888486E-06, -8.6033242E-06, 3.0530537E-06, -8.8274119E-06, 2.7931235E-06, -9.0647736E-06, 2.4287717E-06, -9.1123165E-06, 2.2041925E-06, -9.3113758E-06, 1.9574502E-06, -9.570872E-06, 1.6724928E-06, -9.8433084E-06, 1.3760808E-06, -1.0169161E-05, 9.4028786E-07, -1.0302771E-05, 6.7718412E-07, -1.0575231E-05, 3.6072893E-07, -1.0908478E-05, -6.0187082E-09, -1.1273628E-05, -3.9666017E-07, -1.1665654E-05, -8.1375958E-07, -1.198708E-05, -1.2617437E-06, -1.2435425E-05, -1.760843E-06, -1.2923912E-05, -2.1099861E-06, -1.1779727E-05, -2.4372714E-06, -1.1839555E-05, -2.938503E-06, -1.2363488E-05, -3.5017906E-06, -1.2937129E-05, -4.017536E-06, -1.3189094E-05, -4.7853587E-06, -1.3663169E-05, -5.2905857E-06, -1.3278684E-05, -5.5562227E-06, -1.3227756E-05, -6.2176946E-06, -1.3891939E-05, -6.9239363E-06, -1.4521574E-05, -7.751366E-06, -1.4966952E-05, -8.5643169E-06, -1.6349568E-05, -9.6396479E-06, -1.6228541E-05, -1.0217708E-05, -1.7199751E-05, -1.1880693E-05, -1.7971117E-05, -1.2192392E-05, -1.7942664E-05, -1.250713E-05, -1.7753282E-05, -1.362098E-05, -1.8989705E-05, -1.4444555E-05, -1.9404946E-05, -1.5372729E-05, -1.8690995E-05, -1.7359194E-05, -1.9068002E-05, -1.5629737E-05, -1.8054601E-05, -1.676851E-05, -1.7839955E-05, -1.5462922E-05, -1.4165116E-05, -1.2195708E-05, -1.0766778E-05, -1.063318E-05, -6.2886033E-06, -6.225082E-06
};

int crossfeed_init(crossfeed_t *filter, int samplerate) {
	memset(filter, 0, sizeof(crossfeed_t));
	switch(samplerate) {
	case 44100:
		filter->filter = kernel_44k;
		filter->delay = 0;
		filter->len = sizeof(kernel_44k)/sizeof(float);
		break;
	case 48000:
		filter->filter = kernel_48k;
		filter->delay = 0;
		filter->len = sizeof(kernel_48k)/sizeof(float);
		break;
	case 96000:
		filter->filter = kernel_96k;
		filter->delay = 0;
		filter->len = sizeof(kernel_96k)/sizeof(float);
		break;
	default:
		return -1;
	}
	return 0;
}

static inline void crossfeed_process_sample(crossfeed_t *filter, float left, float right,
                                            float *oleft, float *oright) {
	float mid = (left + right) / 2;
	float side = (left - right) / 2;
	float oside = 0;
	filter->mid[(filter->pos + filter->delay) % filter->len] = mid;
	filter->side[filter->pos] = side;
	if(!filter->bypass) {
		for(unsigned int i=0;i<filter->len;++i) {
			oside += filter->side[(filter->pos + filter->len - i) % filter->len] * filter->filter[i];
		}
	} else {
		oside = filter->side[(filter->pos + filter->len - filter->delay) % filter->len];
	}
	*oleft = filter->mid[filter->pos] + oside;
	*oright = filter->mid[filter->pos] - oside;
	filter->pos = (filter->pos + 1) % filter->len;
}

void crossfeed_filter(crossfeed_t *filter, float *input, float *output, unsigned int size) {
	for(unsigned int i=0;i<size;++i) {
		crossfeed_process_sample(filter, input[i*2], input[i*2+1], &output[i*2],
		                         &output[i*2+1]);
	}
}

void crossfeed_filter_inplace_noninterleaved(crossfeed_t *filter, float *left, float *right,
                                             unsigned int size) {
	for(unsigned int i=0;i<size;++i) {
		crossfeed_process_sample(filter, left[i], right[i], &left[i],
		                         &right[i]);
	}
}
