/*
 * Copyright (c) 2013 Jeremy Pepper
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 *  * Redistributions of source code must retain the above copyright notice,
 *    this list of conditions and the following disclaimer.
 *  * Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *  * Neither the name of crossfeed nor the names of its contributors may
 *    be used to endorse or promote products derived from this software
 *    without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */

#include "crossfeed.h"
#include <string.h>

static const float kernel_96k[] = {
	1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -0.12079715, -0.16337833, -0.11155132, -0.070334852, -0.044668935, -0.031552959, -0.022942079, -0.018355014, -0.014792344, -0.012847221, -0.01110846, -0.010149362, -0.0091714021, -0.0086397491, -0.0080326581, -0.0076808934, -0.0072738854, -0.0070569431, -0.006766357, -0.0066089774, -0.0063901413, -0.0062667155, -0.0060942317, -0.0059908731, -0.0058493726, -0.0057576122, -0.0056379121, -0.0055530109, -0.0054486687, -0.005367768, -0.0052749817, -0.0051960773, -0.0051124115, -0.0050342144, -0.004957594, -0.0048799566, -0.0048087942, -0.0047315932, -0.0046647647, -0.0045880736, 0, -0.0044488478, -0.0043883324, -0.0043131621, -0.0042553912, -0.0041809957, -0.0041256575, -0.0040519899, -0.0039992025, -0.0039263177, -0.0038722332, -0.0037993449, -0.0037518647, -0.0036801859, -0.0036351923, -0.0035644853, -0.0035217877, -0.0034522375, -0.003411765, -0.0033432916, -0.0033050608, -0.0032378165, -0.003201701, -0.003135741, -0.003101812, -0.0030369211, -0.0030051304, -0.0029414948, -0.0029117549, -0.0028493218, -0.0028216294, -0.0027604823, -0.0027346942, -0.0026747421, -0.0026509524, -0.0025921389, -0.0025701935, -0.0025125851, -0.0024924083, -0.0024360425, -0.002417594, -0.0023623421, -0.0023455913, -0.0022914123, -0.0022763116, -0.0022231929, -0.0022096783, -0.0021576458, -0.0021455325, -0.0020945873, -0.002083943, -0.0020340187, -0.0020246559, -0.0019757783, -0.001967768, -0.0019226976, -0.0019156693, -0.0018684114, -0.0018625235, -0.0018166781, -0.0018120883, -0.0017670627, -0.0017635366, -0.0017193764, -0.0017169669, -0.0016736246, -0.0016722296, -0.0016296121, -0.0016291949, -0.0015873581, -0.0015878781, -0.0015466989, -0.0015481567, -0.0015076894, -0.0015100564, -0.0014701558, -0.0014733881, -0.0014341106, -0.0014381311, -0.0013994711, -0.0014042661, -0.0013661602, -0.0013716801, -0.0013340804, -0.0013403732, -0.0013032573, -0.0013103053, -0.0012735884, -0.0012813195, -0.0012449821, -0.0012533774, -0.0012173878, -0.0012264509, -0.0011908542, -0.0012004694, -0.0011650518, -0.0011754337, -0.0011403664, -0.0011510011, -0.0011165042, -0.0011274836, -0.0010936469, -0.0011047557, -0.0010716389, -0.0010831206, -0.0010504884, -0.0010621129, -0.0010301328, -0.0010420291, -0.0010100934, -0.0010227392, -0.00099080417, -0.0010035298, -0.00097131939, -0.00098492217, -0.00095149485, -0.00096580305, -0.00093430217, -0.00094745529, -0.00091571186, -0.00092852057, -0.00089820725, -0.00091235072, -0.00088002527, -0.00089434453, -0.00086320256, -0.00087612501, -0.000846393, -0.00085814967, -0.00082833774, -0.00084216648, -0.00081156066, -0.0008258812, -0.00079436647, -0.00080871844, -0.00077925122, -0.00079187786, -0.00076296867, -0.00077455025, -0.00074637664, -0.00076101971, -0.00072876317, -0.00074426079, -0.00071750447, -0.00073097635, -0.0006975538, -0.0007143059, -0.00068323582, -0.00069813587, -0.00066632766, -0.0006793178, -0.00065208273, -0.00066802738, -0.00063831807, -0.00065546366, -0.0006276308, -0.00064448197, -0.00061475643, -0.00062615325, -0.00060062698, -0.00061772694, -0.00059031823, -0.00059325545, -0.00057195505, -0.00058761192, -0.0005604882, -0.00056289387, -0.00053697301, -0.00054998609, -0.00052879413, -0.00054492668, -0.00052208517, -0.00053463067, -0.00051451597, -0.00051166001, -0.00048925244, -0.0005012792, -0.00047865548, -0.00049437227, -0.00046930517, -0.00047326845, -0.00045372749, -0.00046915663, -0.00045249675, -0.00046821951, -0.00045239192, -0.00046729844, -0.0004512537, -0.00042795466, -0.00041156643, -0.00041429052, -0.00039673148, -0.00040650385, -0.00037465908, -0.00038556315, -0.00036901468, -0.00037976116, -0.00036850432, -0.00035757347, -0.0003433708, -0.00035247914, -0.00033841998, -0.00033932322, -0.0003240355, -0.00032232096, -0.00029898377, -0.00030721957, -0.00027350258, -0.00027566755, -0.00027084319, -0.00026093112, -0.0002531542, -0.00025786535, -0.00025358831, -0.00025718141, -0.00015299987, -0.00014788321, -0.00015682176, -0.00016542384, -0.00014671568, -0.0001420591, -0.00013191914, -0.00013409772, -0.00010879651, -0.00010267504, -0.00010171254, -0.00010332318, -9.8325661E-05, -9.9915793E-05, -9.5228126E-05, -9.072158E-05, -8.6372558E-05, -8.6657463E-05, -6.2307459E-05, -6.4054257E-05, -6.2125844E-05, -6.0234161E-05, -5.8357313E-05, -5.8166443E-05, -5.7165274E-05, -5.8919028E-05, -3.9043745E-05, -3.9974821E-05, -3.6176483E-05, -3.6111433E-05, -3.484228E-05, -3.2107881E-05, -3.0081954E-05, -1.5938554E-05, -1.5355496E-05, -1.5459693E-05, -1.5095003E-05, -1.5403182E-05, -1.5394191E-05, -1.5368618E-05, -1.4771182E-05, -1.4957862E-05, -1.434957E-05, -1.4727982E-05, -1.4505542E-05, -1.4143686E-05, -1.3672964E-05, -1.3520524E-05, -1.3075366E-05, -1.3127086E-05, -1.283049E-05, -1.3074083E-05, -1.2949019E-05, -1.2043693E-05, -1.0919032E-05, -9.3725612E-06, -8.8942879E-06, -8.3706655E-06, -7.2999683E-06, -6.5421486E-06, -4.2657111E-06, -4.152585E-06, -4.068705E-06, -3.9583829E-06, -3.90373E-06, -3.6764286E-06, -3.2337275E-06, -2.1836577E-06, -2.0036343E-06
};

static const float kernel_48k[] = {
	1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -0.27798355, -0.1912874, -0.070722617, -0.043664753, -0.025887411, -0.022166457, -0.016902806, -0.016126597, -0.013743138, -0.013534356, -0.012224127, -0.012113629, -0.011260218, -0.011139737, -0.010521083, -0.010366449, -0.0098833935, -0.0096946955, -0.0092977658, -0.0090806847, 0, -0.0085067013, -0.0082163736, -0.0079651074, -0.0077049066, -0.0074252691, -0.0072251703, -0.0069422582, -0.0067704944, -0.0064877034, -0.0063414411, -0.0060613574, -0.0059381179, -0.0056626867, -0.0055608712, -0.0052911532, -0.0052090934, -0.004945518, -0.0048816889, -0.0046248464, -0.0045778058, -0.004327782, -0.0042959214, -0.0040527242, -0.0040350598, -0.0038010883, -0.0037886477, -0.003565873, -0.0035654027, -0.0033485421, -0.0033589939, -0.0031477427, -0.0031681331, -0.0029620312, -0.0029917215, -0.0027904739, -0.0028285321, -0.0026318245, -0.0026775717, -0.0024849186, -0.0025377905, -0.0023489832, -0.0024082346, -0.002223152, -0.0022881923, -0.0021061832, -0.0021768133, -0.0019977314, -0.0020733443, -0.0018961759, -0.0019770698, -0.0018021588, -0.0018861748, -0.0017143188, -0.0018019449, -0.0016313933, -0.001722739, -0.0015535478, -0.0016471782, -0.0014796366, -0.0015767427, -0.0014103203, -0.0015048587, -0.0013398961, -0.001439337, -0.0012759091, -0.001376717, -0.0012124847, -0.0013141287, -0.0011498093, -0.0012537193, -0.0010918552, -0.0011900601, -0.0010354952, -0.0011405537, -0.00098850194, -0.0010812524, -0.00092882675, -0.0010322037, -0.00088786107, -0.00097160373, -0.00083106075, -0.00093403284, -0.00077585137, -0.00086989143, -0.00073641521, -0.00083607802, -0.00069050281, -0.00078870408, -0.00064667116, -0.00073851133, -0.0006133272, -0.00069617055, -0.0005754694, -0.00066566851, -0.00055587234, -0.00064828544, -0.00051840121, -0.00060559559, -0.00048259614, -0.00056873751, -0.00045741332, -0.00053275819, -0.00042737316, -0.00050657673, -0.00040380753, -0.00047797285, -0.00037402028, -0.00045016478, -0.00036391296, -0.00043815657, -0.00035253304, -0.00042389886, -0.00032000447, -0.00039132152, -0.000308346, -0.00037907314, -0.00027783783, -0.0003423134, -0.00026685407, -0.00032820844, -0.00025549572, -0.00031915426, -0.00024950845, -0.00031331106, -0.00024375985, -0.0003047121, -0.00023167512, -0.00029377788, -0.00021098087, -0.00026917647, -0.00020554932, -0.0002579671, -0.00018912554, -0.00023573737, -0.00017905277, -0.00023202364, -0.00017541638, -0.00022846548, -0.00016780417, -0.00021377717, -0.00015001174, -0.00019520467, -0.00014349622, -0.00018977791, -0.00013678463, -0.00018114578, -0.00013246907, -0.00017386078, -0.00012782137, -0.00016796069, -0.00012296741, -0.00015612481, -0.00011261507, -0.00015220777, -0.0001102789, -0.0001500918, -0.00010704304, -0.00014521441, -0.00010239414, -0.00013779983, -9.8622368E-05, -0.00013624132, -9.7093209E-05, -0.00013474705, -9.5630734E-05, -0.00013330959, -9.4215975E-05, -0.00013194424, -9.2857961E-05, -0.00013062269, -9.1576927E-05, -0.00012372661, -8.6374093E-05, -0.00012256874, -8.5246626E-05, -0.00012145493, -8.4158331E-05, -0.00012039653, -8.3126106E-05, -0.00011938276, -7.840027E-05, -0.00010510991, -7.0282556E-05, -9.9222394E-05, -6.4363572E-05, -9.1616261E-05, -6.1061284E-05, -8.9104113E-05, -5.7946596E-05, -8.4555191E-05, -5.6343295E-05, -7.9851336E-05, -5.3928739E-05, -7.8362355E-05, -5.284524E-05, -7.7584045E-05, -5.2107272E-05, -7.6913471E-05, -5.1647155E-05, -7.6398479E-05, -5.1188679E-05, -7.567666E-05, -5.1435945E-05, -7.4678544E-05, -4.8547212E-05, -7.1392235E-05, -4.6201563E-05, -6.8201334E-05, -4.3981076E-05, -6.4259257E-05, -4.0819988E-05, -6.1584222E-05, -4.0454262E-05, -6.1234496E-05, -4.0116771E-05, -6.091359E-05, -3.9805906E-05, -6.0615068E-05, -3.9515187E-05, -6.0328133E-05, -3.9249466E-05, -6.0075472E-05, -3.5653135E-05, -5.4012533E-05, -3.3670352E-05, -5.1547999E-05, -3.3120356E-05, -5.1024115E-05, -3.2959349E-05, -5.0875133E-05, -3.2814118E-05, -5.0669114E-05, -3.2645698E-05, -5.0529205E-05, -3.2426888E-05, -4.9808783E-05, -3.2214321E-05, -5.0078084E-05, -3.2209933E-05, -5.0031318E-05, -3.2176926E-05, -4.9978076E-05, -3.2173215E-05, -4.9965314E-05, -3.2241784E-05, -4.9931834E-05, -3.2433043E-05, -4.9778384E-05, -3.2531188E-05, -4.9367205E-05, -3.1695476E-05, -4.8929815E-05, -3.1529416E-05, -4.8870806E-05, -3.1529122E-05, -4.8882961E-05, -3.1590007E-05, -4.8938346E-05, -3.170062E-05, -4.9001901E-05, -3.1996355E-05, -4.9082304E-05, -3.1980067E-05, -4.8713046E-05, -3.1773463E-05, -4.8425514E-05, -3.1584699E-05, -4.8200272E-05, -2.3974078E-05, -3.505015E-05, -2.2852701E-05, -3.4013156E-05, -2.1270227E-05, -3.2634231E-05, -2.1077552E-05, -3.170321E-05, -1.977043E-05, -2.7452872E-05, -1.7392435E-05, -2.6467062E-05, -1.7635908E-05, -2.6273499E-05, -1.7675044E-05, -2.624728E-05, -1.76181E-05, -2.6221725E-05, -1.7824856E-05, -2.6091297E-05, -1.7605482E-05, -2.5850486E-05, -1.7628659E-05, -2.5049067E-05, -1.679424E-05, -2.4732784E-05, -1.6717564E-05, -2.4764047E-05, -1.6798058E-05, -2.4890505E-05, -1.6924569E-05, -2.5152187E-05, -1.7159891E-05, -2.485812E-05, -1.7031511E-05, -2.4939762E-05, -1.7179444E-05, -2.5126417E-05, -1.7399194E-05, -2.5363624E-05, -1.766857E-05, -2.5644687E-05, -1.7991357E-05, -2.6004E-05, -1.8477656E-05, -2.6075504E-05, -1.8545377E-05, -2.61403E-05, -1.8657604E-05, -2.6409192E-05, -1.490994E-05, -2.1106192E-05, -1.5217134E-05, -2.0820069E-05, -1.517751E-05, -2.0825417E-05, -1.5429114E-05, -2.0876385E-05, -1.5723916E-05, -2.1019951E-05, -1.5844917E-05, -2.1143585E-05, -1.6440372E-05, -2.1219445E-05, -1.6061458E-05, -2.0637355E-05, -1.5676598E-05, -2.0670037E-05, -1.5984275E-05, -2.1124935E-05, -1.6779122E-05, -2.1012098E-05, -1.6393633E-05, -2.0476436E-05, -1.6941583E-05, -2.0508656E-05, -1.6158789E-05, -2.0136662E-05, -1.5974705E-05, -2.0025662E-05, -1.6201819E-05, -2.0373458E-05, -1.680399E-05, -2.0882459E-05, -1.7464954E-05, -2.0969326E-05, -1.8502733E-05, -2.1014401E-05, -1.7350969E-05, -2.0322381E-05, -1.7937851E-05, -2.0449101E-05, -1.6849233E-05, -1.7718923E-05, -1.5251765E-05, -1.7824656E-05, -1.6126744E-05, -1.8241379E-05, -1.6036302E-05, -1.7793847E-05, -1.5862408E-05, -1.7662098E-05, -1.5942824E-05, -1.6939235E-05, -1.5798163E-05, -1.6580299E-05, -1.537491E-05, -1.5883987E-05, -1.4026577E-05, -1.5299624E-05, -3.7918701E-06, -3.6754293E-06, -2.5806198E-06, -2.2257843E-06, -2.197859E-06, -2.1262956E-06, -2.0755888E-06
};

static const float kernel_44k[] = {
	1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -0.2975587, -0.18895446, -0.065671906, -0.04188329, -0.024949096, -0.022065911, -0.016999256, -0.016492769, -0.01415171, -0.014036532, -0.012719527, -0.012628296, -0.011750049, -0.011612599, -0.01096281, -0.010772805, -0.010257513, -0.010024304, 0, -0.0093322778, -0.0089698685, -0.0086840345, -0.0083723981, -0.0080744065, -0.0077885999, -0.0074707386, -0.0072612907, -0.0069357636, -0.0067598918, -0.0064372253, -0.0062918537, -0.0059746196, -0.0058568083, -0.0055466015, -0.0054539228, -0.0051515317, -0.0050821067, -0.0047877068, -0.0047393339, -0.004453253, -0.0044240109, -0.0041460413, -0.0041340981, -0.0038714523, -0.0038664471, -0.0036111923, -0.0036186208, -0.0033736809, -0.0033941902, -0.0031556645, -0.0031880089, -0.0029555724, -0.0029986042, -0.0027716432, -0.0028245945, -0.0026027092, -0.0026644289, -0.0024472375, -0.0025169761, -0.0023040769, -0.0023812519, -0.0021721348, -0.0022559001, -0.0020502582, -0.002140217, -0.0019361163, -0.0020331242, -0.001832603, -0.001934842, -0.0017352176, -0.0018394983, -0.001644067, -0.0017514209, -0.0015572604, -0.0016695199, -0.0014764132, -0.0015884725, -0.0013986091, -0.0015141178, -0.0013244173, -0.0014402732, -0.0012551218, -0.0013703357, -0.0011838513, -0.0013017292, -0.0011184007, -0.0012328586, -0.001052796, -0.0011636103, -0.00099113607, -0.0010969344, -0.00092250149, -0.001039492, -0.0008768143, -0.00097770721, -0.00081354537, -0.00092751562, -0.00076635712, -0.00087268784, -0.00072571723, -0.00083135883, -0.00066535105, -0.00077331351, -0.0006286609, -0.00072777306, -0.0005950458, -0.00070250558, -0.00054880232, -0.00065366348, -0.00050686725, -0.00060654542, -0.00048807482, -0.00056768185, -0.00044871622, -0.0005431305, -0.00043267038, -0.00051618763, -0.00040873629, -0.0004738023, -0.00036929539, -0.00044136267, -0.00034302403, -0.00042717584, -0.00032960114, -0.00041003493, -0.00031409221, -0.0003823438, -0.00029077646, -0.00035961444, -0.00027233118, -0.00034783766, -0.00026049011, -0.00033215014, -0.00023786748, -0.00030761494, -0.00022348986, -0.00029047724, -0.00020892711, -0.00027305676, -0.0001995503, -0.00026359136, -0.000191101, -0.00025484341, -0.00018060615, -0.00023878423, -0.00017225572, -0.00022941765, -0.00016502915, -0.00022242979, -0.00015758428, -0.00021440774, -0.00014756674, -0.00019504581, -0.00013689371, -0.00018855385, -0.00013046096, -0.00017754207, -0.0001239769, -0.00017248631, -0.00011577946, -0.00016363432, -0.000112867, -0.00015267867, -0.00010421522, -0.00014970583, -0.00010212349, -0.0001476739, -0.00010008192, -0.00014572327, -9.8208009E-05, -0.00014389832, -8.9556619E-05, -0.00012885268, -8.5132284E-05, -0.0001260203, -8.08369E-05, -0.00011809698, -7.7610137E-05, -0.00011533288, -7.5509983E-05, -0.00010677797, -6.8613437E-05, -0.00010421344, -6.7345201E-05, -9.9469653E-05, -6.3954896E-05, -9.8182405E-05, -6.2445455E-05, -9.661846E-05, -6.0702128E-05, -9.3313349E-05, -5.8273064E-05, -9.1222522E-05, -5.6302706E-05, -8.8153341E-05, -5.2238196E-05, -8.2046339E-05, -4.906705E-05, -7.8210862E-05, -4.8358448E-05, -7.7320503E-05, -4.7563997E-05, -7.6659657E-05, -4.6921399E-05, -7.5170654E-05, -4.5376528E-05, -7.3558396E-05, -4.4490502E-05, -7.271568E-05, -4.336868E-05, -7.1271243E-05, -4.2788994E-05, -7.0760572E-05, -4.2304928E-05, -7.0276998E-05, -4.1837637E-05, -6.9807051E-05, -4.0876625E-05, -6.8531568E-05, -4.0464467E-05, -6.8119371E-05, -4.0068975E-05, -6.7727393E-05, -3.9701419E-05, -6.735947E-05, -3.9355757E-05, -6.7010653E-05, -3.9061808E-05, -6.6643588E-05, -3.8973023E-05, -6.6168082E-05, -3.6505378E-05, -5.8798931E-05, -3.3887194E-05, -5.8497997E-05, -3.3628003E-05, -5.8241789E-05, -3.3383705E-05, -5.8006659E-05, -3.3171276E-05, -5.7800593E-05, -3.2974523E-05, -5.7607835E-05, -3.2801872E-05, -5.7439593E-05, -3.2650369E-05, -5.7289915E-05, -3.252814E-05, -5.7162426E-05, -2.7447843E-05, -4.8329155E-05, -2.7400229E-05, -4.8262889E-05, -2.7400149E-05, -4.8159382E-05, -2.679329E-05, -4.5365126E-05, -2.331518E-05, -4.0140025E-05, -2.2706759E-05, -3.9952836E-05, -2.2689457E-05, -3.9787516E-05, -2.317508E-05, -3.935568E-05, -2.2108688E-05, -3.8801183E-05, -2.1864884E-05, -3.8653005E-05, -2.1761329E-05, -3.8571307E-05, -2.1694743E-05, -3.8521554E-05, -2.1660675E-05, -3.8480906E-05, -2.164824E-05, -3.8472474E-05, -2.1663578E-05, -3.8471393E-05, -2.1706095E-05, -3.8552389E-05, -2.199176E-05, -3.7959951E-05, -1.9183877E-05, -3.3915614E-05, -1.9087105E-05, -3.3878212E-05, -1.9077925E-05, -3.388093E-05, -1.909614E-05, -3.3904133E-05, -1.9136442E-05, -3.3948068E-05, -1.9205629E-05, -3.3998371E-05, -1.9327161E-05, -3.4047614E-05, -1.9332139E-05, -3.4092474E-05, -1.9426911E-05, -3.4204331E-05, -1.9556623E-05, -3.4324083E-05, -1.9758183E-05, -3.443925E-05, -1.9847135E-05, -3.4552802E-05, -2.0045385E-05, -3.4678222E-05, -2.0162312E-05, -3.4748369E-05, -2.0330319E-05, -3.4948745E-05, -2.0608535E-05, -3.5148543E-05, -2.1077305E-05, -3.5287718E-05, -2.1310245E-05, -3.5160105E-05, -2.1113561E-05, -3.5030494E-05, -2.1154196E-05, -3.5144221E-05, -2.1355485E-05, -3.5188754E-05, -2.1471515E-05, -3.5407706E-05, -2.1735725E-05, -3.5786121E-05, -2.216049E-05, -3.5770659E-05, -2.2378938E-05, -3.6236568E-05, -2.2731085E-05, -3.5770707E-05, -2.2690887E-05, -3.5921672E-05, -2.1117881E-05, -2.1821763E-05, -1.3877921E-05, -2.1249807E-05, -1.3840302E-05, -2.0596526E-05, -1.3299836E-05, -2.0477522E-05, -1.3442329E-05, -2.0703976E-05, -1.2967343E-05, -1.9528319E-05, -1.3092724E-05, -1.996277E-05, -1.3472913E-05, -1.9732021E-05, -1.3666936E-05, -1.9900041E-05, -1.365139E-05, -1.9992205E-05, -1.3783976E-05, -1.9556282E-05, -1.377682E-05, -1.9756071E-05, -1.4208246E-05, -1.9421361E-05, -1.3894355E-05, -1.9365571E-05, -1.328474E-05, -1.6567796E-05, -1.2162088E-05, -1.6685748E-05, -1.2546946E-05, -1.66724E-05, -1.2514335E-05, -1.6775142E-05, -1.1622632E-05, -1.5429412E-05, -1.207154E-05, -1.5530013E-05, -1.2204184E-05, -1.5473172E-05, -1.2436029E-05, -1.5430656E-05, -1.2071994E-05, -1.5185577E-05, -1.2105076E-05, -1.4902615E-05, -1.1958407E-05, -1.4893414E-05, -1.2024264E-05, -1.4462033E-05, -1.1916541E-05, -1.4503506E-05, -1.2101998E-05, -1.5045517E-05, -1.2503819E-05, -1.5064137E-05, -1.2354947E-05, -1.4062866E-05, -1.1949229E-05, -1.0623932E-05, -9.4166307E-06, -1.096503E-05, -9.5276373E-06, -1.0285007E-05, -8.9669575E-06, -8.3248824E-06, -5.5954079E-06, -5.2275695E-06, -3.5913451E-06, -3.742201E-06, -2.9904427E-06, -3.0577123E-06, -3.001697E-06
};

int crossfeed_init(crossfeed_t *filter, int samplerate) {
	memset(filter, 0, sizeof(crossfeed_t));
	switch(samplerate) {
	case 44100:
		filter->filter = kernel_44k;
		filter->delay = 0;
		filter->len = sizeof(kernel_44k)/sizeof(float);
		break;
	case 48000:
		filter->filter = kernel_48k;
		filter->delay = 0;
		filter->len = sizeof(kernel_48k)/sizeof(float);
		break;
	case 96000:
		filter->filter = kernel_96k;
		filter->delay = 0;
		filter->len = sizeof(kernel_96k)/sizeof(float);
		break;
	default:
		return -1;
	}
	return 0;
}

static inline void crossfeed_process_sample(crossfeed_t *filter, float left, float right,
                                            float *oleft, float *oright) {
	float mid = (left + right) / 2;
	float side = (left - right) / 2;
	float oside = 0;
	filter->mid[(filter->pos + filter->delay) % filter->len] = mid;
	filter->side[filter->pos] = side;
	if(!filter->bypass) {
		for(unsigned int i=0;i<filter->len;++i) {
			oside += filter->side[(filter->pos + filter->len - i) % filter->len] * filter->filter[i];
		}
	} else {
		oside = filter->side[(filter->pos + filter->len - filter->delay) % filter->len];
	}
	*oleft = filter->mid[filter->pos] + oside;
	*oright = filter->mid[filter->pos] - oside;
	filter->pos = (filter->pos + 1) % filter->len;
}

void crossfeed_filter(crossfeed_t *filter, float *input, float *output, unsigned int size) {
	for(unsigned int i=0;i<size;++i) {
		crossfeed_process_sample(filter, input[i*2], input[i*2+1], &output[i*2],
		                         &output[i*2+1]);
	}
}

void crossfeed_filter_inplace_noninterleaved(crossfeed_t *filter, float *left, float *right,
                                             unsigned int size) {
	for(unsigned int i=0;i<size;++i) {
		crossfeed_process_sample(filter, left[i], right[i], &left[i],
		                         &right[i]);
	}
}
